(function(i,s){typeof exports=="object"&&typeof module<"u"?s(exports,require("chalk"),require("form-data"),require("os"),require("path"),require("fs"),require("axios"),require("child_process"),require("zip-folder"),require("open"),require("http"),require("events"),require("https"),require("url"),require("ora"),require("arg"),require("inquirer"),require("util"),require("execa"),require("listr"),require("json5"),require("ncp")):typeof define=="function"&&define.amd?define(["exports","chalk","form-data","os","path","fs","axios","child_process","zip-folder","open","http","events","https","url","ora","arg","inquirer","util","execa","listr","json5","ncp"],s):(i=typeof globalThis<"u"?globalThis:i||self,s(i["FireCMS CLI"]={},i.chalk,i.FormData,i.os,i.path,i.fs,i.axios,i.child_process,i.zipFolder,i.open,i.http,i.EventEmitter,i.https,i.url,i.ora,i.arg,i.inquirer,i.util,i.execa,i.Listr,i.JSON5,i.ncp))})(this,function(i,s,M,A,u,d,p,Y,z,N,J,W,H,C,P,w,F,$,V,Z,G,K){"use strict";var R=typeof document<"u"?document.currentScript:null;function q(e){const o=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const t in e)if(t!=="default"){const n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(o,t,n.get?n:{enumerable:!0,get:()=>e[t]})}}return o.default=e,Object.freeze(o)}const b=q(A),Q=q(u),m="https://api-kdoe6pj3qq-ey.a.run.app",y="https://api-drplyi3b6q-ey.a.run.app",X=`<html lang="en">
<head>
    <style>
        html, body {
            font-family: Rubik, sans-serif;
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Rubik">
</head>

<body>

<img src="https://firecms.co/img/firecms_logo.svg" alt="FireCMS logo" width="100" height="100">

<h2>FireCMS CLI</h2>

<p style="margin: 0;">You can now close this tab</p>

<script>

    setTimeout(function () {
        window.close();
    }, 3000);

<\/script>

</body>
</html>

`;async function g(e,o){o&&console.log("Getting current user");const t=await _(e,o);return t?(o&&console.log("userCredential",t),I(t.id_token)):null}async function h(e,o){const t=new W,n=await g(e,o);if(n){console.log("You are already logged in as",n.email),console.log(`Run ${s.bold("firecms logout")} to sign out`);return}const r=new Set,c=J.createServer(async(l,a)=>{if(a.setHeader("Cache-Control","no-store, max-age=0"),l.url==="/"){const f=await oe(e);console.log("Opening browser to",f),a.writeHead(301,{Location:f}),a.end()}if(l.url.startsWith("/oauth2callback")){let f=C.parse(l.url,!0).query;if(f.error)throw console.log("Error:"+f.error),c.close(),f.error;a.writeHead(200),a.end(X,()=>l.socket.end()),t.emit("tokensReady",f.code)}}).listen(3e3);return c.on("connection",l=>{r.add(l),l.on("close",()=>{r.delete(l)})}),N("http://localhost:3000"),new Promise(async(l,a)=>{t.once("tokensReady",async f=>{const v=await te(f,e);if(v)console.log("You have successfully logged in."),T(v,e),l(v);else return a("Token could not be obtained");for(const je of r)je.destroy();c.close()})})}function T(e,o){const t=u.join(b.homedir(),".firecms");d.existsSync(t)||d.mkdirSync(t);const n=u.join(t,(o==="dev"?"staging.":"")+"tokens.json"),r=JSON.stringify(e);d.writeFile(n,r,c=>{if(c)throw c})}async function S(e,o){const t=await _(e,o);if(!t){console.log("âš ï¸ You are not logged in"),console.log(`Run ${s.red.bold("firecms login")} to log in`);return}ee(t.access_token);const n=u.join(b.homedir(),".firecms"),r=u.join(n,(e==="dev"?"staging.":"")+"tokens.json");d.unlinkSync(r),console.log("You have successfully logged out.")}async function _(e,o){const t=u.join(b.homedir(),".firecms"),n=u.join(t,(e==="dev"?"staging.":"")+"tokens.json");return d.existsSync(n)?new Promise((r,c)=>{d.readFile(n,"utf8",(l,a)=>{if(o&&console.log("getTokens",{data:a}),l){c(l);return}const f=JSON.parse(a);f.env==="dev"&&console.log("Using DEV environment"),r(f)})}):null}function ee(e,o){let t="token="+e,n={host:"oauth2.googleapis.com",port:"443",path:"/revoke",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(t)}};const r=H.request(n,function(c){c.setEncoding("utf8"),c.on("data",l=>{})});r.on("error",c=>{console.log(c)}),r.write(t),r.end()}function I(e){if(!e)throw new Error("No JWT token");const t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=Buffer.from(t,"base64");return JSON.parse(n.toString())}async function oe(e){const o=e==="prod"?y:m;return(await p.get(o+"/cli/generate_auth_url",{params:{redirect_uri:"http://localhost:3000/oauth2callback/"}})).data.data}async function j(e,o,t){if(o){const n=new Date(o.expiry_date),r=new Date;if(n.getTime()>r.getTime())return o}try{const n=e==="prod"?y:m,c=(await p.post(n+"/cli/refresh_access_token",o)).data.data;return T({...o,...c,env:e},e),c}catch(n){return t&&t(n),await S(e,!1),console.error(`
Error refreshing credentials`,n.response?.status,n.response?.data?.message),console.log(`âš ï¸ Run ${s.red.bold("firecms login")} to log in again`),null}}async function te(e,o){const t=o==="prod"?y:m;return(await p.get(t+"/cli/exchange_code_for_token",{params:{code:e}})).data.data}async function x(e,o,t){if(!await g(o,t)){console.log("âš ï¸ You are not logged in"),console.log(`Run ${s.red.bold("firecms login")} to log in`);return}console.log("Starting deploy");const r=await U();await E(e,r,o,t)}function ne(){Y.exec("yarn build",(e,o,t)=>{if(e)return console.error(`exec error: ${e}`);console.log(`stdout: ${o}`),console.error(`stderr: ${t}`)})}async function U(){return new Promise((e,o)=>{const t=b.tmpdir(),n=Q.join(t,"firecms_build.zip");z("./dist/assets",n,function(r){r?o(r):e(n)})})}async function E(e,o,t,n){t==="dev"&&console.log("!!! Uploading to dev server");const r=P("Uploading build of project "+e).start(),c=await j(t,await _(t,n)),l=new M;if(!d.existsSync(o)){console.error(`File ${o} does not exist`);return}l.append("zip",d.createReadStream(o),"file.zip");try{const a=t==="prod"?y:m,f=await p.post(`${a}/projects/${e}/upload_config`,l,{headers:{...l.getHeaders(),"x-admin-authorization":`Bearer ${c.access_token}`},maxContentLength:1/0,maxBodyLength:1/0});f.status===200?(r.succeed(),console.log("ðŸ”¥ Successfully uploaded new build"),console.log(`
Check it out at`,(t==="prod"?"https://app.firecms.co/":"https://staging.app.firecms.co/")+`p/${e}`)):(console.error("There was an error uploading the build"),console.error(f.data),r.fail())}catch(a){console.error("There was an error uploading the build"),console.error(a.response.data),r.fail()}}const re=$.promisify(d.access),ie=$.promisify(K);function se(e,o){const t=u.parse(e).root;for(;e&&e!==t;){if(u.basename(e)===o)return e;e=u.dirname(e)}return null}const D=C.fileURLToPath(typeof document>"u"&&typeof location>"u"?require("url").pathToFileURL(D).href:typeof document>"u"?location.href:R&&R.src||new URL("index.cjs",document.baseURI).href),ce=u.dirname(D),ae=se(ce,"cli");async function k(e){console.log(`
${s.green.bold(" ___ _          ___ __  __ ___")}
${s.green.bold("| __(_)_ _ ___ / __|  \\/  / __|")}
${s.green.bold("| _|| | '_/ -_) (__| |\\/| \\__ \\")}
${s.green.bold("|_| |_|_| \\___|\\___|_|  |_|___/")}

${s.red.bold("Welcome to the FireCMS CLI")} ðŸ”¥
`);let o=le(e),t=await g(o.env,o.debug);if(["cloud","pro","community"].includes(o.template)&&!t){if(console.log("You need to be logged in to create a project"),await F.prompt([{type:"confirm",name:"login",message:"Do you want to log in?",default:!0}]).then(async c=>{if(c.login)return h(o.env,o.debug)}),!await g(o.env,o.debug)){console.log("The login process was not completed. Exiting...");return}}else t&&console.log("You are logged in as",t.email);o=await de(o),await L(o)}function le(e){const o=w({"--git":Boolean,"--yes":Boolean,"--skipInstall":Boolean,"--projectId":String,"--v2":Boolean,"--pro":Boolean,"--community":Boolean,"--debug":Boolean,"--env":String},{argv:e.slice(2)}),t=o["--env"]||"prod";if(t!=="prod"&&t!=="dev"){console.log("Please specify a valid environment: dev or prod"),console.log("create-firecms-app --env=prod");return}let n="cloud";return o["--v2"]?n="v2":o["--pro"]?n="pro":o["--community"]&&(n="community"),{git:o["--git"]||!1,dir_name:o._[0],template:n,debug:o["--debug"]||!1,firebaseProjectId:o["--projectId"],env:t}}async function de(e){const o="my-cms",t=[];if(e.template!=="v2"){e.template==="cloud"&&t.push({type:"confirm",name:"existing_firecms_project",message:"Do you already have a FireCMS Cloud project?",default:!0});const r=P("Loading your projects").start(),c=await me(e.env,e.debug,a=>{r.fail("Error loading projects")}).then(a=>(a||(r.isSpinning&&r.fail("Error loading projects"),process.exit(1)),r.succeed(),a)).catch(a=>{r.isSpinning&&r.fail("Error loading projects")});c.filter(a=>a.fireCMSProject).length||(console.log("No FireCMS projects found"),process.exit(1)),t.push({type:"list",name:"firebaseProjectId",message:"Select your project",when:a=>!!a.existing_firecms_project||e.template!=="cloud",choices:c.map(a=>a.projectId)})}t.push({type:"input",name:"dir_name",message:"Please choose which folder to create the project in",when:r=>!!r.existing_firecms_project||e.template!=="cloud",default:e.dir_name??o}),e.git||t.push({type:"confirm",name:"git",message:"Initialize a git repository?",when:r=>!!r.firebaseProjectId,default:!1});const n=await F.prompt(t);return e.template==="cloud"&&!n.existing_firecms_project&&(console.log("Please create a FireCMS Cloud project first. Head to https://app.firecms.co to get started and then run this command again!"),process.exit(1)),{...e,dir_name:n.dir_name??e.dir_name,git:e.git||n.git,firebaseProjectId:n.firebaseProjectId}}async function L(e){const o="./"+e.dir_name;d.existsSync(o)?d.readdirSync(o).length!==0&&(console.error("%s Directory is not empty",s.red.bold("ERROR")),process.exit(1)):d.mkdirSync(o);const t=u.resolve(process.cwd(),o);e={...e,targetDirectory:t};let n;if(e.template==="v2")n="template_v2";else if(e.template==="pro")n="template_pro";else if(e.template==="community")n="template";else if(e.template==="cloud")n="template_cloud";else throw new Error("createProject: Invalid template");const r=u.resolve(ae,"./templates/"+n);e.templateDirectory=r;try{await re(r,d.constants.R_OK)}catch{console.error("%s Invalid template name "+r,s.red.bold("ERROR")),process.exit(1)}if(await new Z([{title:"Copy project files: "+e.templateDirectory,task:l=>ue(e,l.webappConfig)},{title:"Initialize git",task:()=>ge(e),enabled:()=>e.git}]).run(),console.log(""),console.log("%s Your project is ready!",s.green.bold("DONE")),console.log(""),e.template==="v2")console.log("First update your firebase config in"),console.log(s.bgYellow.black.bold("src/firebase_config.ts")),console.log(""),console.log("Then run:"),console.log(s.cyan.bold("cd "+e.dir_name)),console.log(s.cyan.bold("yarn")),console.log(s.cyan.bold("yarn dev")),console.log("");else if(e.template==="pro"||e.template==="community")console.log("Run:"),console.log(s.cyan.bold("cd "+e.dir_name)),console.log(s.cyan.bold("yarn")),console.log(s.cyan.bold("yarn dev")),console.log("");else if(e.template==="cloud")console.log("If you want to run your project locally, run:"),console.log(s.bgYellow.black.bold("cd "+e.dir_name)),console.log(s.bgYellow.black.bold("yarn install")),console.log(s.bgYellow.black.bold("yarn dev")),console.log(""),console.log("If you want to deploy your project, run:"),console.log(s.bgYellow.black.bold("yarn deploy")),console.log("and see it running in https://app.firecms.co");else throw new Error("createProject: Invalid template");return!0}async function ue(e,o){return ie(e.templateDirectory,e.targetDirectory,{clobber:!1,dot:!0}).then(async t=>{if(e.template==="v2")o&&pe(e,o);else if(e.template==="pro"||e.template==="community"){const n=await ye(e.env,e.firebaseProjectId,e.debug);return await fe(e,n),B(e,["./src/App.tsx","./firebase.json","./package.json","./.firebaserc"])}else if(e.template==="cloud")return B(e,["./src/App.tsx","./package.json"])})}async function fe(e,o){const t=u.resolve(e.targetDirectory,"src/firebase_config.ts");d.writeFile(t,"export const firebaseConfig = "+JSON.stringify(o,null,4),n=>{n&&console.error("Failed to write file:",n)})}async function B(e,o=[]){for(const t of o){const n=u.resolve(e.targetDirectory,t);await d.readFile(n,"utf8",function(r,c){if(r)return console.log(r);const l=c.replace(/\[REPLACE_WITH_PROJECT_ID]/g,e.firebaseProjectId);d.writeFile(n,l,"utf8",function(a){if(a)return console.log(a)})})}}async function ge(e){if((await V("git",["init"],{cwd:e.targetDirectory})).failed)return Promise.reject(new Error("Failed to initialize git"))}function pe(e,o){d.writeFile(e.targetDirectory+"/src/firebase_config.ts",`export const firebaseConfig = ${G.stringify(o,null,"	")};`,function(t){if(t)return console.log(t)})}async function me(e,o,t){try{const n=await _(e,o),r=await j(e,n,t);if(!r)return null;const c=e==="prod"?y:m,l=await p.get(c+"/gcp_projects",{headers:{"x-admin-authorization":`Bearer ${r.access_token}`}});return l.status>=400?(console.log(l.data.data?.message),null):l.data.data}catch(n){t&&t(n),console.error("Error getting projects",n.response?.data)}}async function ye(e,o,t,n){try{const r=await _(e,t),c=await j(e,r,n);if(!c)return null;const l=e==="prod"?y:m,a=await p.get(l+`/projects/${o}/webapp_config`,{headers:{"x-admin-authorization":`Bearer ${c.access_token}`}});return a.status>=400?(console.log(a.data.data?.message),null):a.data.data}catch(r){n&&n(r),console.error("Error getting projects",r.response?.data)}}async function _e(e){if(e.length<2){O();return}const o=e[2];if(o==="init")await k(e);else if(o==="login")await we(e);else if(o==="logout")await be(e);else if(o==="deploy")await he(e);else{o&&console.log("Unknown command",o),O();return}}async function we(e){const o=w({"--env":String,"--debug":Boolean},{argv:e.slice(2)}),t=o["--env"]||"prod",n=o["--debug"]||!1;if(t!=="prod"&&t!=="dev"){console.log("Please specify a valid environment: dev or prod"),console.log("firecms login --env=prod");return}await h(t,n)}async function be(e){const o=w({"--env":String,"--debug":Boolean},{argv:e.slice(2)}),t=o["--env"]||"prod",n=o["--debug"]||!1;if(t!=="prod"&&t!=="dev"){console.log("Please specify a valid environment: dev or prod"),console.log("firecms logout --env=prod");return}await S(t,n)}async function he(e){const o=w({"--project":String,"--env":String,"--debug":Boolean},{argv:e.slice(2)}),t=o["--project"];if(!t){console.log("Please specify a project:"),console.log("firecms deploy --project=your-project-id");return}const n=o["--env"]||"prod",r=o["--debug"]||!1;if(n!=="prod"&&n!=="dev"){console.log("Please specify a valid environment:"),console.log("firecms deploy --project=your-project-id --env=dev");return}await g(n,r)||await h(n,r),await x(t,n,r)}async function O(e="prod",o=!1){console.log(`
${s.red.bold("Welcome to the FireCMS CLI ðŸ”¥ðŸ”¥ðŸ”¥")}

${s.green.bold("Usage")}
firecms ${s.blue.bold("<command>")} [options]

${s.green.bold("Commands")}
${s.blue.bold("login")} - Login to FireCMS
${s.blue.bold("logout")} - Sign out
${s.blue.bold("init")} - Create a new CMS project
${s.blue.bold("deploy")} - Deploy an existing CMS project
`);const t=await g(e,o);t&&console.log(`${s.green.bold("Current user")}
${t.email}
`)}i.build=ne,i.createFireCMSApp=k,i.createProject=L,i.createZipFromBuild=U,i.deploy=x,i.entry=_e,i.getCurrentUser=g,i.getTokens=_,i.login=h,i.logout=S,i.parseJwt=I,i.refreshCredentials=j,i.uploadZip=E,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=index.cjs.map
