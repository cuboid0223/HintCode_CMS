(function(d,c){typeof exports=="object"&&typeof module<"u"?c(exports,require("react"),require("firebase/firestore"),require("react/jsx-runtime"),require("@firecms/ui"),require("yup"),require("@firecms/core"),require("@firecms/formex"),require("date-fns"),require("date-fns/locale")):typeof define=="function"&&define.amd?define(["exports","react","firebase/firestore","react/jsx-runtime","@firecms/ui","yup","@firecms/core","@firecms/formex","date-fns","date-fns/locale"],c):(d=typeof globalThis<"u"?globalThis:d||self,c(d.FireCMS={},d.React,d.firestore,d.jsxRuntime,d.ui,d.Yup,d.core,d.formex,d.dateFns,d.locales))})(this,function(d,c,U,e,l,ae,k,P,te,ie){"use strict";function z(o){const s=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(o){for(const r in o)if(r!=="default"){const a=Object.getOwnPropertyDescriptor(o,r);Object.defineProperty(s,r,a.get?a:{enumerable:!0,get:()=>o[r]})}}return s.default=o,Object.freeze(s)}const B=z(ae),de=z(ie),ce=["Admin"],he={read:!1,edit:!1,create:!1,delete:!1};function J({collection:o,user:s}){const r=s?.roles;if(r){if(o.ownerId===s?.uid)return{read:!0,create:!0,edit:!0,delete:!0};{const a={read:!1,create:!1,edit:!1,delete:!1};return r.map(n=>ge(n,o.id)).reduce(Y,a)}}else return he}function ge(o,s){const r={read:o.isAdmin||o.defaultPermissions?.read,create:o.isAdmin||o.defaultPermissions?.create,edit:o.isAdmin||o.defaultPermissions?.edit,delete:o.isAdmin||o.defaultPermissions?.delete};return o.collectionPermissions&&o.collectionPermissions[s]?Y(o.collectionPermissions[s],r):o.defaultPermissions?Y(o.defaultPermissions,r):r}const Y=(o,s)=>({read:o.read||s.read,create:o.create||s.create,edit:o.edit||s.edit,delete:o.delete||s.delete});function fe(o,s){return o?s.roles?s.roles.map(r=>o.find(a=>a.id===r.id)).filter(Boolean):[]:void 0}const H=(o,s)=>{const r=o.map(n=>n.id),a=s.map(n=>n.id);return r.length===s.length&&r.every(n=>a.includes(n))};function Ce(o,s){if(!s)return;const r=ue(s),a=new Date(r.exp*1e3);localStorage.setItem(`auth_token::${o}`,JSON.stringify({token:s,expiry:a}))}function me(o){const s=localStorage.getItem(`auth_token::${o}`);if(s){const r=JSON.parse(s);if(r.expiry=new Date(r.expiry),r.expiry>new Date)return r.token}}function pe(){for(let o=0;o<localStorage.length;o++){const s=localStorage.key(o);s?.startsWith("auth_token::")&&localStorage.removeItem(s)}}function ue(o){if(!o)throw new Error("No JWT token");const r=o.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),a=decodeURIComponent(window.atob(r).split("").map(function(n){return"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(a)}function be(o,s=10){if(!/^#([0-9A-Fa-f]{3}){1,2}$/.test(o))throw new Error("Invalid color format");let r=o.substring(1).split("");r.length===3&&(r=[r[0],r[0],r[1],r[1],r[2],r[2]]);let a=parseInt(r[0]+r[1],16),n=parseInt(r[2]+r[3],16),f=parseInt(r[4]+r[5],16);return a=Math.floor(a*(1-s/100)),n=Math.floor(n*(1-s/100)),f=Math.floor(f*(1-s/100)),"#"+(a<16?"0":"")+a.toString(16)+(n<16?"0":"")+n.toString(16)+(f<16?"0":"")+f.toString(16)}function ve(o,s=10){if(!/^#([0-9A-Fa-f]{3}){1,2}$/.test(o))throw new Error("Invalid color format");let r=o.substring(1).split("");r.length===3&&(r=[r[0],r[0],r[1],r[1],r[2],r[2]]);const a=parseInt(r[0]+r[1],16),n=parseInt(r[2]+r[3],16),f=parseInt(r[4]+r[5],16),m=s/100;return`rgba(${a}, ${n}, ${f}, ${m})`}function ye({firebaseApp:o,usersPath:s="__FIRECMS/config/users",rolesPath:r="__FIRECMS/config/roles",usersLimit:a,canEditRoles:n=!0,allowDefaultRolesCreation:f,includeCollectionConfigPermissions:m}){const[v,F]=c.useState(!0),[y,h]=c.useState(!0),[x,D]=c.useState([]),[i,b]=c.useState([]),w=i.map(p=>({...p,roles:x.filter(u=>p.roles?.includes(u.id))})),[T,_]=c.useState(),[$,g]=c.useState(),C=v||y;c.useEffect(()=>{if(!o||!r)return;const p=U.getFirestore(o);return U.onSnapshot(U.collection(p,r),{next:u=>{_(void 0);try{const S=Te(u.docs);D(S)}catch(S){console.error("Error loading roles",S),_(S)}F(!1)},error:u=>{console.error("Error loading roles",u),_(u),F(!1)}})},[o,r]),c.useEffect(()=>{if(!o||!s)return;const p=U.getFirestore(o);return U.onSnapshot(U.collection(p,s),{next:u=>{g(void 0);try{const S=we(u.docs);b(S)}catch(S){console.error("Error loading users",S),g(S)}h(!1)},error:u=>{console.error("Error loading users",u),g(u),h(!1)}})},[o,s]);const N=c.useCallback(async p=>{if(!o)throw Error("useFirestoreUserManagement Firebase not initialised");const u=U.getFirestore(o);if(!u||!s)throw Error("useFirestoreUserManagement Firestore not initialised");console.debug("Persisting user",p);const S=p.roles?.map(De=>De.id),{uid:V,...j}=p,ne={...j,roles:S};return V?U.setDoc(U.doc(u,s,V),ne,{merge:!0}).then(()=>p):U.addDoc(U.collection(u,s),ne).then(()=>p)},[s,o]),I=c.useCallback(p=>{if(!o)throw Error("useFirestoreUserManagement Firebase not initialised");const u=U.getFirestore(o);if(!u||!r)throw Error("useFirestoreUserManagement Firestore not initialised");console.debug("Persisting role",p);const{id:S,...V}=p,j=U.doc(u,r,S);return U.setDoc(j,V,{merge:!0})},[r,o]),A=c.useCallback(async p=>{if(!o)throw Error("useFirestoreUserManagement Firebase not initialised");const u=U.getFirestore(o);if(!u||!s)throw Error("useFirestoreUserManagement Firestore not initialised");console.debug("Deleting",p);const{uid:S}=p;return U.deleteDoc(U.doc(u,s,S))},[s,o]),t=c.useCallback(p=>{if(!o)throw Error("useFirestoreUserManagement Firebase not initialised");const u=U.getFirestore(o);if(!u||!r)throw Error("useFirestoreUserManagement Firestore not initialised");console.debug("Deleting",p);const{id:S}=p,V=U.doc(u,r,S);return U.deleteDoc(V)},[r,o]),E=c.useCallback(({collection:p,user:u})=>J({collection:p,user:u}),[]),M=c.useCallback(p=>{if(!w)throw Error("Users not loaded");return w.find(S=>S.email?.toLowerCase()===p?.email?.toLowerCase())?.roles},[w]),q=c.useCallback(({user:p})=>{if(console.debug("Authenticating user",p),C)return console.warn("User management is still loading"),!1;if(w.length===0||w.find(S=>S.email?.toLowerCase()===p?.email?.toLowerCase()))return!0;throw Error("Could not find a user with the provided email in the user management system.")},[C,w]);return{loading:C,roles:x,users:w,saveUser:N,saveRole:I,rolesError:T,deleteUser:A,deleteRole:t,usersLimit:a,usersError:$,canEditRoles:n===void 0?!0:n,allowDefaultRolesCreation:f===void 0?!0:f,includeCollectionConfigPermissions:!!m,collectionPermissions:E,defineRolesFor:M,authenticator:q}}const we=o=>o.map(s=>{const r=s.data();return{uid:s.id,...r,created_on:r?.created_on?.toDate(),updated_on:r?.updated_on?.toDate()}}),Te=o=>o.map(s=>({id:s.id,...s.data()})),W=c.createContext({});function G({children:o,userManagement:s}){return e.jsx(W.Provider,{value:s,children:o})}const L=()=>c.useContext(W);function O({role:o}){let s;return o.isAdmin?s="blueDarker":o.id==="editor"?s="yellowLight":o.id==="viewer"?s="grayLight":s=l.getColorSchemeForSeed(o.id),e.jsx(l.Chip,{colorScheme:s,children:o.name},o.id)}const K=B.object().shape({id:B.string().required("Required"),name:B.string().required("Required")});function Q({open:o,role:s,editable:r,handleClose:a,collections:n}){const{saveRole:f}=L(),m=!s,[v,F]=c.useState(),y=c.useCallback(t=>(F(void 0),f(t)),[f]),h=P.useCreateFormex({initialValues:s??{name:""},onSubmit:(t,E)=>y(t).then(()=>{E.resetForm({values:t}),a()}).catch(M=>F(M)),validation:t=>K.validate(t,{abortEarly:!1}).then(()=>({})).catch(E=>{const M={};return E.inner.forEach(q=>{M[q.path]=q.message}),M})}),{isSubmitting:x,touched:D,values:i,errors:b,handleChange:w,setFieldValue:T,dirty:_,setFieldTouched:$}=h,g=i.isAdmin??!1,C=i.defaultPermissions?.create??!1,N=i.defaultPermissions?.read??!1,I=i.defaultPermissions?.edit??!1,A=i.defaultPermissions?.delete??!1;return c.useEffect(()=>{!P.getIn(D,"id")&&i.name&&T("id",k.toSnakeCase(i.name))},[D,i.name]),e.jsx(l.Dialog,{open:o,maxWidth:"4xl",children:e.jsx(P.Formex,{value:h,children:e.jsxs("form",{noValidate:!0,autoComplete:"off",onSubmit:h.handleSubmit,style:{display:"flex",flexDirection:"column",position:"relative",height:"100%"},children:[e.jsxs(l.DialogContent,{className:"flex-grow",children:[e.jsx("div",{className:"flex flex-row pt-12 pb-8",children:e.jsx(l.Typography,{variant:"h4",className:"flex-grow",children:"Role"})}),e.jsxs("div",{className:"grid grid-cols-12 gap-8",children:[e.jsxs("div",{className:"col-span-12 md:col-span-8",children:[e.jsx(l.TextField,{name:"name",required:!0,error:D.name&&!!b.name,value:i.name,disabled:g||!r,onChange:w,"aria-describedby":"name-helper-text",label:"Name"}),e.jsx(k.FieldCaption,{children:D.name&&b.name?b.name:"Name of this role"})]}),e.jsxs("div",{className:"col-span-12 md:col-span-4",children:[e.jsx(l.TextField,{name:"id",required:!0,error:D.id&&!!b.id,value:i.id,disabled:!m||!r,onChange:t=>{w(t),$("id",!0)},"aria-describedby":"id-helper-text",label:"ID"}),e.jsx(k.FieldCaption,{children:D.id&&b.id?b.id:"ID of this role"})]}),e.jsxs("div",{className:"col-span-12",children:[e.jsx(l.Paper,{className:"bg-inherit",children:e.jsxs(l.Table,{children:[e.jsxs(l.TableHeader,{children:[e.jsx(l.TableCell,{}),e.jsx(l.TableCell,{align:"center",children:"Create entities"}),e.jsx(l.TableCell,{align:"center",children:"Read entities"}),e.jsx(l.TableCell,{align:"center",children:"Update entities"}),e.jsx(l.TableCell,{align:"center",children:"Delete entities"})]}),e.jsxs(l.TableBody,{children:[e.jsxs(l.TableRow,{children:[e.jsx(l.TableCell,{scope:"row",children:e.jsx("strong",{children:"All collections"})}),e.jsx(l.TableCell,{align:"center",children:e.jsx(l.Tooltip,{title:"Create entities in collections",children:e.jsx(l.Checkbox,{disabled:g||!r,checked:(g||C)??!1,onCheckedChange:t=>T("defaultPermissions.create",t)})})}),e.jsx(l.TableCell,{align:"center",children:e.jsx(l.Tooltip,{title:"Access all data in every collection",children:e.jsx(l.Checkbox,{disabled:g||!r,checked:(g||N)??!1,onCheckedChange:t=>T("defaultPermissions.read",t)})})}),e.jsx(l.TableCell,{align:"center",children:e.jsx(l.Tooltip,{title:"Update data in any collection",children:e.jsx(l.Checkbox,{disabled:g||!r,checked:(g||I)??!1,onCheckedChange:t=>T("defaultPermissions.edit",t)})})}),e.jsx(l.TableCell,{align:"center",children:e.jsx(l.Tooltip,{title:"Delete data in any collection",children:e.jsx(l.Checkbox,{disabled:g||!r,checked:(g||A)??!1,onCheckedChange:t=>T("defaultPermissions.delete",t)})})})]}),n&&n.map(t=>e.jsxs(l.TableRow,{children:[e.jsx(l.TableCell,{scope:"row",children:t.name}),e.jsx(l.TableCell,{align:"center",children:e.jsx(l.Checkbox,{disabled:g||C||!r,checked:(g||C||P.getIn(i,`collectionPermissions.${t.path}.create`))??!1,onCheckedChange:E=>T(`collectionPermissions.${t.path}.create`,E)})}),e.jsx(l.TableCell,{align:"center",children:e.jsx(l.Checkbox,{disabled:g||N||!r,checked:(g||N||P.getIn(i,`collectionPermissions.${t.path}.read`))??!1,onCheckedChange:E=>T(`collectionPermissions.${t.path}.read`,E)})}),e.jsx(l.TableCell,{align:"center",children:e.jsx(l.Checkbox,{disabled:g||I||!r,checked:(g||I||P.getIn(i,`collectionPermissions.${t.path}.edit`))??!1,onCheckedChange:E=>T(`collectionPermissions.${t.path}.edit`,E)})}),e.jsx(l.TableCell,{align:"center",children:e.jsx(l.Checkbox,{disabled:g||A||!r,checked:(g||A||P.getIn(i,`collectionPermissions.${t.path}.delete`))??!1,onCheckedChange:E=>T(`collectionPermissions.${t.path}.delete`,E)})})]},t.name))]})]})}),e.jsx(k.FieldCaption,{children:"You can customise the permissions that the users related to this role can perform in the entities of each collection"})]}),e.jsxs("div",{className:"col-span-12 md:col-span-4",children:[e.jsxs(l.Select,{error:D.config&&!!b.config,id:"createCollections",name:"createCollections",label:"Create collections",position:"item-aligned",disabled:g||!r,onChange:t=>T("config.createCollections",t.target.value==="true"),value:g||i.config?.createCollections?"true":"false",renderValue:t=>t==="true"?"Yes":"No",children:[e.jsx(l.SelectItem,{value:"true",children:" Yes "}),e.jsx(l.SelectItem,{value:"false",children:" No "})]}),e.jsx(k.FieldCaption,{children:D.config&&b.config?b.config:"Can the user create collections"})]}),e.jsxs("div",{className:"col-span-12 md:col-span-4",children:[e.jsxs(l.Select,{error:D.config&&!!b.config,id:"editCollections",name:"editCollections",label:"Edit collections",disabled:g||!r,position:"item-aligned",onChange:t=>T("config.editCollections",t.target.value==="own"?"own":t.target.value==="true"),value:g?"true":i.config?.editCollections==="own"?"own":i.config?.editCollections?"true":"false",renderValue:t=>t==="own"?"Own":t==="true"?"Yes":"No",children:[e.jsx(l.SelectItem,{value:"true",children:" Yes "}),e.jsx(l.SelectItem,{value:"false",children:" No "}),e.jsx(l.SelectItem,{value:"own",children:" Only his/her own "})]}),e.jsx(k.FieldCaption,{children:D.config&&b.config?b.config:"Can the user edit collections"})]}),e.jsxs("div",{className:"col-span-12 md:col-span-4",children:[e.jsxs(l.Select,{error:D.config&&!!b.config,id:"deleteCollections",name:"deleteCollections",label:"Delete collections",disabled:g||!r,position:"item-aligned",onChange:t=>T("config.deleteCollections",t.target.value==="own"?"own":t.target.value==="true"),value:g?"true":i.config?.deleteCollections==="own"?"own":i.config?.deleteCollections?"true":"false",renderValue:t=>t==="own"?"Own":t==="true"?"Yes":"No",children:[e.jsx(l.SelectItem,{value:"true",children:" Yes "}),e.jsx(l.SelectItem,{value:"false",children:" No "}),e.jsx(l.SelectItem,{value:"own",children:" Only his/her own "})]}),e.jsx(k.FieldCaption,{children:D.config&&b.config?b.config:"Can the user delete collections"})]})]})]}),e.jsxs(l.DialogActions,{position:"sticky",children:[v&&e.jsx(l.Typography,{className:"text-red-500",children:"There was an error saving this role"}),e.jsx(l.Button,{variant:"text",onClick:()=>{a()},children:"Cancel"}),e.jsx(l.LoadingButton,{variant:"filled",color:"primary",type:"submit",disabled:!_,loading:x,startIcon:e.jsx(l.DoneIcon,{}),children:m?"Create role":"Update"})]})]})})})}const X=[{id:"admin",name:"Admin",isAdmin:!0},{id:"editor",name:"Editor",isAdmin:!1,defaultPermissions:{read:!0,create:!0,edit:!0,delete:!0},config:{createCollections:!0,editCollections:"own",deleteCollections:"own"}},{id:"viewer",name:"Viewer",isAdmin:!1,defaultPermissions:{read:!0,create:!1,edit:!1,delete:!1}}];function Z({onRoleClicked:o,editable:s}){const{roles:r,saveRole:a,deleteRole:n,allowDefaultRolesCreation:f}=L(),[m,v]=c.useState(void 0),[F,y]=c.useState(!1);return e.jsxs("div",{className:"w-full overflow-auto",children:[e.jsxs(l.Table,{children:[e.jsxs(l.TableHeader,{children:[e.jsx(l.TableCell,{header:!0,className:"w-16"}),e.jsx(l.TableCell,{header:!0,children:"Role"}),e.jsx(l.TableCell,{header:!0,className:"items-center",children:"Is Admin"}),e.jsx(l.TableCell,{header:!0,children:"Default permissions"})]}),e.jsxs(l.TableBody,{children:[r&&r.map(h=>{const x=h.isAdmin||h.defaultPermissions?.create,D=h.isAdmin||h.defaultPermissions?.read,i=h.isAdmin||h.defaultPermissions?.edit,b=h.isAdmin||h.defaultPermissions?.delete;return e.jsxs(l.TableRow,{onClick:()=>{o(h)},children:[e.jsx(l.TableCell,{style:{width:"64px"},children:!h.isAdmin&&e.jsx(l.Tooltip,{title:"Delete this role",children:e.jsx(l.IconButton,{size:"small",disabled:!s,onClick:w=>(w.stopPropagation(),v(h)),children:e.jsx(l.DeleteIcon,{})})})}),e.jsx(l.TableCell,{children:e.jsx(O,{role:h})}),e.jsx(l.TableCell,{className:"items-center",children:e.jsx(l.Checkbox,{checked:h.isAdmin??!1})}),e.jsx(l.TableCell,{children:e.jsxs("ul",{children:[x&&e.jsx("li",{children:"Create"}),D&&e.jsx("li",{children:"Read"}),i&&e.jsx("li",{children:"Update"}),b&&e.jsx("li",{children:"Delete"})]})})]},h.name)}),(!r||r.length===0)&&e.jsx(l.TableRow,{children:e.jsx(l.TableCell,{colspan:4,children:e.jsxs(l.CenteredView,{className:"flex flex-col gap-4 my-8 items-center",children:[e.jsx(l.Typography,{variant:"label",children:"You don't have any roles yet."}),f&&e.jsx(l.Button,{variant:"outlined",onClick:()=>{X.forEach(h=>{a(h)})},children:"Create default roles"})]})})})]})]}),e.jsx(k.DeleteConfirmationDialog,{open:!!m,loading:F,onAccept:()=>{m&&(y(!0),n(m).then(()=>{v(void 0)}).finally(()=>{y(!1)}))},onCancel:()=>{v(void 0)},title:e.jsx(e.Fragment,{children:"Delete?"}),body:e.jsx(e.Fragment,{children:"Are you sure you want to delete this role?"})})]})}const R=c.memo(function({children:s}){const{collections:r}=k.useNavigationController(),[a,n]=c.useState(!1),[f,m]=c.useState(),{canEditRoles:v}=L(),F=c.useCallback(h=>{n(!0),m(h)},[]),y=()=>{m(void 0),n(!1)};return e.jsxs(l.Container,{className:"w-full flex flex-col py-4 gap-4",maxWidth:"6xl",children:[s,e.jsxs("div",{className:"flex items-center mt-12",children:[e.jsx(l.Typography,{gutterBottom:!0,variant:"h4",className:"flex-grow",component:"h4",children:"Roles"}),e.jsx(l.Tooltip,{title:v?void 0:"Update plans to customise roles",children:e.jsx(l.Button,{size:"large",disabled:!v,startIcon:e.jsx(l.AddIcon,{}),onClick:()=>n(!0),children:"Add role"})})]}),e.jsx(Z,{onRoleClicked:F,editable:!!v}),e.jsx(Q,{open:a,role:f,editable:v,collections:r,handleClose:y},f?.id??"new")]})}),ee=B.object().shape({displayName:B.string().required("Required"),email:B.string().email().required("Required"),roles:B.array().min(1)});function Se(o,s,r,a,n){const f=r.filter(y=>y.roles?.map(h=>h.id).includes("admin")),m=o.roles?.map(y=>y.id).includes("admin");if((!n||!H(n.roles??[],s.roles??[]))&&!m)throw new Error("Only admins can change roles");if(n&&n.roles?.map(y=>y.id).includes("admin")&&!s.roles?.map(y=>y.id).includes("admin")&&f.length===1)throw new Error("There must be at least one admin");return!0}function le({open:o,user:s,handleClose:r}){const a=k.useSnackbarController(),{user:n}=k.useAuthController(),{saveUser:f,users:m,roles:v}=L(),F=!s,y=c.useCallback(C=>{if(!n)throw new Error("Logged user not found");try{return Se(n,C,m,v,s),f(C)}catch(N){return Promise.reject(N)}},[v,f,s,m,n]),h=P.useCreateFormex({initialValues:s??{displayName:"",email:"",roles:v.filter(C=>C.id==="editor")},validation:C=>ee.validate(C,{abortEarly:!1}).then(()=>({})).catch(N=>N.inner.reduce((I,A)=>(I[A.path]=A.message,I),{})),onSubmit:(C,N)=>y(C).then(()=>{r(),N.resetForm({values:C})}).catch(I=>{a.open({type:"error",message:I.message})})}),{isSubmitting:x,touched:D,handleChange:i,values:b,errors:w,setFieldValue:T,dirty:_,handleSubmit:$,submitCount:g}=h;return e.jsx(l.Dialog,{open:o,onOpenChange:C=>C?void 0:r(),maxWidth:"4xl",children:e.jsx(P.Formex,{value:h,children:e.jsxs("form",{onSubmit:$,autoComplete:"off",noValidate:!0,style:{display:"flex",flexDirection:"column",position:"relative",height:"100%"},children:[e.jsxs(l.DialogContent,{className:"h-full flex-grow",children:[e.jsx("div",{className:"flex flex-row pt-4 pb-4",children:e.jsx(l.Typography,{variant:"h4",className:"flex-grow",children:"User"})}),e.jsxs("div",{className:"grid grid-cols-12 gap-8",children:[e.jsxs("div",{className:"col-span-12",children:[e.jsx(l.TextField,{name:"displayName",required:!0,error:g>0&&!!w.displayName,value:b.displayName??"",onChange:i,"aria-describedby":"name-helper-text",label:"Name"}),e.jsx(k.FieldCaption,{children:g>0&&w.displayName?w.displayName:"Name of this user"})]}),e.jsxs("div",{className:"col-span-12",children:[e.jsx(l.TextField,{required:!0,error:g>0&&!!w.email,name:"email",value:b.email??"",onChange:i,"aria-describedby":"email-helper-text",label:"Email"}),e.jsx(k.FieldCaption,{children:g>0&&w.email?w.email:"Email of this user"})]}),e.jsx("div",{className:"col-span-12",children:e.jsx(l.MultiSelect,{label:"Roles",value:b.roles?.map(C=>C.id)??[],onMultiValueChange:C=>T("roles",C.map(N=>v.find(I=>I.id===N))),renderValue:C=>{const N=v.find(I=>I.id===C);return N?e.jsx("div",{className:"flex flex-wrap space-x-2 space-y-2",children:e.jsx(O,{role:N},N?.id)}):null},children:v.map(C=>e.jsx(l.MultiSelectItem,{value:C.id,children:e.jsx(O,{role:C},C?.id)},C.id))})})]})]}),e.jsxs(l.DialogActions,{children:[e.jsx(l.Button,{variant:"text",onClick:()=>{r()},children:"Cancel"}),e.jsx(l.LoadingButton,{variant:"filled",color:"primary",type:"submit",disabled:!_,loading:x,startIcon:e.jsx(l.DoneIcon,{}),children:F?"Create user":"Update"})]})]})})})}function re({onUserClicked:o}){const{users:s,saveUser:r,deleteUser:a}=L(),n=k.useAuthController(),f=k.useSnackbarController(),m=k.useCustomizationController(),v=m?.locale?de[m?.locale]:void 0,F=m?.dateTimeFormat??k.defaultDateFormat,[y,h]=c.useState(void 0),[x,D]=c.useState(!1);return e.jsxs("div",{className:"overflow-auto",children:[e.jsxs(l.Table,{children:[e.jsxs(l.TableHeader,{children:[e.jsx(l.TableCell,{className:"truncate w-16"}),e.jsx(l.TableCell,{children:"ID"}),e.jsx(l.TableCell,{children:"Email"}),e.jsx(l.TableCell,{children:"Name"}),e.jsx(l.TableCell,{children:"Roles"}),e.jsx(l.TableCell,{children:"Created on"})]}),e.jsxs(l.TableBody,{children:[s&&s.map(i=>{const b=i.roles,w=i.created_on?te.format(i.created_on,F,{locale:v}):"";return e.jsxs(l.TableRow,{onClick:()=>{o(i)},children:[e.jsx(l.TableCell,{className:"w-10",children:e.jsx(l.Tooltip,{title:"Delete this user",children:e.jsx(l.IconButton,{size:"small",onClick:T=>(T.stopPropagation(),h(i)),children:e.jsx(l.DeleteIcon,{})})})}),e.jsx(l.TableCell,{children:i.uid}),e.jsx(l.TableCell,{children:i.email}),e.jsx(l.TableCell,{className:"font-medium align-left",children:i.displayName}),e.jsx(l.TableCell,{className:"align-left",children:b?e.jsx("div",{className:"flex flex-wrap gap-2",children:b.map(T=>e.jsx(O,{role:T},T?.id))}):null}),e.jsx(l.TableCell,{children:w})]},"row_"+i.uid)}),(!s||s.length===0)&&e.jsx(l.TableRow,{children:e.jsx(l.TableCell,{colspan:6,children:e.jsxs(l.CenteredView,{className:"flex flex-col gap-4 my-8 items-center",children:[e.jsx(l.Typography,{variant:"label",children:"There are no users yet"}),e.jsx(l.Button,{variant:"outlined",onClick:()=>{if(!n.user?.uid)throw Error("UsersTable, authController misconfiguration");r({uid:n.user?.uid,email:n.user?.email,displayName:n.user?.displayName,photoURL:n.user?.photoURL,providerId:n.user?.providerId,isAnonymous:n.user?.isAnonymous,roles:[{id:"admin",name:"Admin"}],created_on:new Date}).then(()=>{f.open({type:"success",message:"User added successfully"})}).catch(i=>{f.open({type:"error",message:"Error adding user: "+i.message})})},children:"Add the logged user as an admin"})]})})})]})]}),e.jsx(k.DeleteConfirmationDialog,{open:!!y,loading:x,onAccept:()=>{y&&(D(!0),a(y).then(()=>{h(void 0)}).catch(i=>{f.open({type:"error",message:"Error deleting user: "+i.message})}).finally(()=>{D(!1)}))},onCancel:()=>{h(void 0)},title:e.jsx(e.Fragment,{children:"Delete?"}),body:e.jsx(e.Fragment,{children:"Are you sure you want to delete this user?"})})]})}const oe=function({children:s}){const[r,a]=c.useState(),[n,f]=c.useState(),{users:m,usersLimit:v}=L(),F=v!==void 0&&m&&m.length>=v,y=c.useCallback(x=>{f(x),a(!0)},[]),h=c.useCallback(()=>{a(!1),f(void 0)},[]);return e.jsxs(l.Container,{className:"w-full flex flex-col py-4 gap-4",maxWidth:"6xl",children:[s,e.jsxs("div",{className:"flex items-center mt-12",children:[e.jsx(l.Typography,{gutterBottom:!0,variant:"h4",className:"flex-grow",component:"h4",children:"Users"}),e.jsx(l.Button,{size:"large",disabled:F,startIcon:e.jsx(l.AddIcon,{}),onClick:()=>a(!0),children:"Add user"})]}),e.jsx(re,{onUserClicked:y}),e.jsx(le,{open:r??!1,user:n,handleClose:h},n?.uid??"new")]})};function Ue({userManagement:o}){const s=o.users.length===0,r=o.roles.length===0;return{key:"user_management",loading:o.loading,homePage:{additionalChildrenStart:s||r?e.jsx(se,{noUsers:s,noRoles:r,userManagement:o}):void 0},provider:{Component:G,props:{userManagement:o}}}}function se({noUsers:o,noRoles:s,userManagement:r}){const a=k.useAuthController(),n=k.useSnackbarController(),f=o&&s?"Create default roles and add current user as admin":o?"Add current user as admin":s?"Create default roles":void 0;return e.jsxs(l.Paper,{className:"my-4 flex flex-col px-4 py-6 bg-white dark:bg-slate-800 gap-2",children:[e.jsx(l.Typography,{variant:"subtitle2",className:"uppercase",children:"Create your users and roles"}),e.jsx(l.Typography,{children:"You have no users or roles defined. You can create default roles and add the current user as admin."}),e.jsxs(l.Button,{onClick:()=>{if(!a.user?.uid)throw Error("UsersTable, authController misconfiguration");o&&r.saveUser({uid:a.user?.uid,email:a.user?.email,displayName:a.user?.displayName,photoURL:a.user?.photoURL,providerId:a.user?.providerId,isAnonymous:a.user?.isAnonymous,roles:[{id:"admin",name:"Admin"}],created_on:new Date}).then(()=>{n.open({type:"success",message:"User added successfully"})}).catch(m=>{n.open({type:"error",message:"Error adding user: "+m.message})}),s&&X.forEach(m=>{r.saveRole(m)})},children:[e.jsx(l.AddIcon,{}),f]})]})}const ke=[{path:"users",name:"CMS Users",group:"Admin",icon:"face",view:e.jsx(oe,{})},{path:"roles",name:"Roles",group:"Admin",icon:"gpp_good",view:e.jsx(R,{})}];d.IntroWidget=se,d.RESERVED_GROUPS=ce,d.RoleChip=O,d.RoleYupSchema=K,d.RolesDetailsForm=Q,d.RolesTable=Z,d.RolesView=R,d.UserDetailsForm=le,d.UserManagementContext=W,d.UserManagementProvider=G,d.UserYupSchema=ee,d.UsersTable=re,d.UsersView=oe,d.areRolesEqual=H,d.cacheDelegatedLoginToken=Ce,d.clearDelegatedLoginTokensCache=pe,d.darkenColor=be,d.getDelegatedLoginTokenFromCache=me,d.getUserRoles=fe,d.hexToRgbaWithOpacity=ve,d.resolveUserRolePermissions=J,d.useFirestoreUserManagement=ye,d.useUserManagement=L,d.useUserManagementPlugin=Ue,d.userManagementAdminViews=ke,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=index.umd.js.map
